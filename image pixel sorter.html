<!doctype html>
<html lang="en-US">
    <head>
		<title>Natski</title>
        <meta charset="UTF-8"/>
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
        <meta name="theme-color" content="#1e1e1e"/>
        <meta name="description" content="ground up website for fun"/>
        <meta name="keywords" content="portfolio, natspooky, natski"/>
        <meta name="author" content="NATSKI"/>
        <meta name="copyright" content="NATSKI">
        <meta name="color-scheme" content="normal">
		<link rel="icon" type="image/svg+xml" href="icon/svg/favicon.svg"/>
        <link rel="apple-touch-icon"sizes="57x57" href="icon/mobile/57.png"/>
        <link rel="apple-touch-icon"sizes="60x60" href="icon/mobile/60.png"/>
        <link rel="apple-touch-icon"sizes="72x72" href="icon/mobile/72.png"/>
        <link rel="apple-touch-icon"sizes="76x76" href="icon/mobile/76.png"/>
        <link rel="apple-touch-icon"sizes="114x114" href="icon/mobile/114.png"/>
        <link rel="apple-touch-icon"sizes="120x120" href="icon/mobile/120.png"/>
        <link rel="apple-touch-icon"sizes="144x144" href="icon/mobile/144.png"/>
        <link rel="apple-touch-icon"sizes="152x152" href="icon/mobile/152.png"/>
        <meta property="og:title" content="Natspooky"/>
        <meta property="og:description" content="ground up website for fun"/>
        <meta property="og:image" content="https://natski.netlify.com/icon/avatar/400.png"/>
        <meta property="og:image:width" content="400"/>
        <meta property="og:image:height" content="400"/>
        <meta property="og:url" content="https://natski.netlify.com"/>
        <meta property="og:locale" content="en_US"/>
        <meta property="og:type" content="website"/>
        <meta property="og:site_name" content="NATSKI"/>
        <meta name="twitter:title" content="Natspooky">
        <meta name="twitter:description" content="ground up website for fun">
        <meta name="twitter:image" content="https://natski.netlify.com/icon/avatar/400.png">
        <meta name="twitter:site" content="@natspooky_">
        <meta name="twitter:creator" content="@natspooky_">
        <meta name="twitter:card" content="summary">
        <link rel="stylesheet" type="text/css" href="lib/css/main.css"/>
        <link rel="stylesheet" type="text/css" href="lib/css/animations.css"/>
        <link rel="stylesheet" type="text/css" media="screen and (orientation: portrait)" href="lib/css/scale.css"/>
        <link rel="prefetch" href="icon/img/kuru.gif">
        <link rel="prefetch" href="icon/img/ki.gif">
        <link rel="prefetch" href="icon/img/nahida.gif">
        <link rel="prefetch" href="icon/img/traveler.gif">
        <link rel="prefetch" href="icon/audio/kuru.mp3">
        <link rel="prefetch" href="icon/audio/kuruine.mp3">
	</head>
    <body>

        
        <div id="colourpanelback"></div>
        <header>
            <div class="observe"></div>
            <div class="imagebox">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 850.89 850.9">
                    <path fill="var(--bar)" d="M757.63.5H92.77C41.58.5.08,41.99.08,93.18v665.02c0,51.19,41.5,92.69,92.69,92.69h664.86c51.19,0,92.68-41.5,92.68-92.69V93.18c0-51.19-41.49-92.68-92.68-92.68ZM383.3,727.2c0,22.08-17.9,39.97-39.98,39.97H123.69c-22.08,0-39.98-17.89-39.98-39.97v-65.37h89.03c17.62,0,31.9-14.29,31.9-31.9v-19.84c0-17.61-14.28-31.89-31.9-31.89h-89.03v-305h89.03c17.62,0,31.9-14.28,31.9-31.9v-19.83c0-17.62-14.28-31.9-31.9-31.9h-89.03v-65.38c0-22.08,17.9-39.98,39.98-39.98h219.63c22.08,0,39.98,17.9,39.98,39.97v603.02ZM766.68,189.56h-89.19c-17.62,0-31.9,14.29-31.9,31.9v19.83c0,17.62,14.28,31.9,31.9,31.9h89.19v305h-89.19c-17.62,0-31.9,14.28-31.9,31.9v19.83c0,17.62,14.28,31.9,31.9,31.9h89.19v65.38c0,22.08-17.9,39.97-39.98,39.97h-219.63c-22.08.01-39.98-17.88-39.98-39.96V124.19c0-22.08,17.9-39.98,39.98-39.98h219.63c22.08,0,39.98,17.9,39.98,39.98v65.37Z"/>
                  </svg>
                <img src="icon/thumbnails/missing.png" alt="pixel sorter" id="headerimage" draggable="false">
            </div>
            <h2>Image Pixel Sorter</h2>
        </header>

        <style>
            .images {
                position: relative;
                width: 100%;
                min-height: 70vh;
                padding: 50px;
                display: flex;
                flex-wrap: wrap;
                justify-content: space-evenly;
                align-items: center;
            }
            .images canvas {
                position: relative;
                height: 50vh;
                background-color: #f0f0f0;
            }
            .tools {
                position: relative;
                width: 100%;
                height: auto;
                padding: 20px;
                display: flex;
                align-items: center;
                justify-content: center;
            }
        </style>
        
        <main>
            <div class="images">
                <!-- image and canvas here-->
                <canvas id="in"></canvas>
                <canvas id="out"></canvas>
            </div>
            <div class="tools">
                <!-- toolbar here -->
                <input type="file" accept="image/*" id="inputImage" />
                <button onclick="toggleSSM()">
                    Open Settings
                </button>
            </div>
        </main>

        <script>
            let processor;
            window.onload = function() {
                processor = new PixelSorter(document.getElementById('out'),document.getElementById('in'))
                document.getElementById('inputImage').addEventListener('change', function(event) {
                    
                    
                    processor.createImageBuffer(this, event)
                })
            }

            class PixelSorter {
                constructor(canvas, imageCanvas) {
                    this.lowBound = 0
                    this.upBound = 1
                    this.matchColour = [0,0,0]
                    this.colourSpace = 'GREY'
                    this.image = []
                    this.outputImage = []
                    this.colourMask = []
                    this.bitMask = []
                    this.imageCanvas = imageCanvas
                    this.imageCTX = this.imageCanvas.getContext('2d')
                    this.outputCanvas = canvas
                    this.outputCTX = this.outputCanvas.getContext('2d')
                }

                readInput(file, element) {
                    let reader = new FileReader()
                    reader.onload = function() {
                        let dataURL = reader.result
                        console.log(dataURL)
                        return Promise.resolve(dataURL)
                    }
                    reader.readAsDataURL(file.files[0]);
                }

                async createImageBuffer(file, element) {
                    let e = new Image()
                    e.onload = function() {
                        let o, c;
                        this.outputCanvas.height = e.naturalHeight || e.offsetHeight || e.height
                        this.outputCanvas.width = e.naturalWidth || e.offsetWidth || e.width
                        c = (this.imageCanvas.height) = e.naturalHeight || e.offsetHeight || e.height, 
                        o = (this.imageCanvas.width) = e.naturalWidth || e.offsetWidth || e.width, 
                        this.imageCTX.drawImage(e, 0, 0)
                        console.log('working')
                        return Promise.resolve(this.CTX.getImageData(0, 0, o, c))
                    }
                    e.onerror = function() {
                        return Promise.resolve([])
                    }
                    e.src = await this.readInput(file, element)

                    
                }


                previewImage(imgD) {
    const reader = new FileReader();

    // PREVIEW
    reader.addEventListener("load", function () {
        imagePreview.src = reader.result;
    })

    // CHECK IF THERE IS SELECTION 
    if (imgD) {
        // CHECK IF THE FILE IS AN IMAGE
        if (imgD.type === "image/jpeg" || imgD.type == "image/jpg" || imgD.type == "image/gif" || imgD.type == "image/png") {
            errorMessage.innerText = "";

            // CONVERTS FILE TO BASE 64
            reader.readAsDataURL(imgD);
        } else {
            errorMessage.innerText = "File type should be an image"
            imagePreview.src = "";
        }
    }
    // IF NO IMAGE
    else {
        imagePreview.src = ""
        errorMessage.innerText = "Please select a picture";
    }
}


                processColourSpace() {

                    switch(this.colourSpace) {

                        case 'GREY':
                            this.processToGreyScale().then((greyMap) => {
                                this.colourMask = greyMap
                                let tempMask = []

                                for(let i = 0; i < this.colourMask.length; i++) {

                                    if(this.colourMask[i] <= this.lowBound || this.colourMask[i] >= this.upBound) {
                                        tempMask.push(0)
                                    }else {
                                        tempMask.push(1)
                                    }
                                
                                }
                                Promise.resolve(tempMask)

                            }).then((bitMask) => {
                                this.bitMask = bitmask
                                let tempImage = []
                                tempImage = this.sortMerge(this.image)
                                for(let i = 0; i < this.image.length; i++) {
                                    if(this.bitMask[i]) {
                                        tempImage[i] = this.image[i]
                                    }
                                    tempImage[i][3] = 255
                                }
                                return Promise.resolve(tempImage)
                            }).then((output) => {
                                this.outputImage = []
                                for(let i = 0; i < this.image.length; i++) {
                                    this.outputImage.push(...output[i])
                                }
                                this.outputCTX.putImageData(this.outputImage, 0, 0, 0, 0, this.outputCanvas.width, this.outputCanvas.height)
                            })

                            break;
            
                        case 'LAB':
                            this.processToLAB()
                            break;
                    }

                }

                colourSpace(colourSpace) {
                    this.colourSpace = colourSpace
                }

                upperBound(upperBound) {
                    this.upBound = upperBound
                }

                lowerBound(lowerBound) {
                    this.lowBound = lowerBound
                }

                matchColour(colour) {
                    this.matchColour = colour
                }

                processToLAB() {
                    //do later
                    return
                }


                processToGreyScale(image) {
                    let tempMask = []
                    this.image = this.processToRGB(image)
                    for(let i = 0; i < this.image.length; i++) {
                        let r = this.image[i][0] * .3, // ------> Red is low
                        g = this.image[i][1] * .59, // ---> Green is high
                        b = this.image[i][2] * .11, // ----> Blue is very low

                        gray = r + g + b


                        this.image[i].push(gray)
                        tempMask.push(gray)
                    }

                    return Promise.resolve(tempMask)
                }

                

                processToRGB(image) {
                    let data = image.data,     
                    dataLength = data.length,
                    tempImage = []
                    console.log(data)
                    //this.greyMask = []
                    for(let i = 0; i < dataLength; i+=4) {
                        let r = data[i],
                        g = data[i+1],
                        b = data[i+2];
                        tempImage.push([r,g,b])
                        //this.greyMask.push(this.processToGreyScale([r,g,b]))
                    }
                    return tempImage
                }


                sortMerge(array) {
    
                    if (array.length <= 1) return array

                    let center = Math.floor(array.length / 2),
                    front = this.sortMerge(array.slice(0, center)),
                    back = this.sortMerge(array.slice(center))

                    return this.merge(front, back)
                }
                merge(left, right) {
                    let sortedArray = []
                    while(left.length && right.length) {

                        if(left[0][3] < right[0][3]) {
                            sortedArray.push(left.shift())
                        }else {
                            sortedArray.push(right.shift())
                        }
                    }
                    return [...sortedArray, ...left, ...right]
                }


                HSV(colour) {
                    let rabs, gabs, babs, rr, gg, bb, h, s, v, diff, diffc, percentRoundFn;
                    rabs = colour[0] / 255;
                    gabs = colour[1] / 255; 
                    babs = colour[2] / 255;
                    v = Math.max(rabs, gabs, babs),
                    diff = v - Math.min(rabs, gabs, babs);
                    diffc = c => (v - c) / 6 / diff + 1 / 2;
                    percentRoundFn = num => Math.round(num * 100) / 100;
                    if (diff == 0) {
                        h = s = 0;
                    } else {
                        s = diff / v;
                        rr = diffc(rabs);
                        gg = diffc(gabs);
                        bb = diffc(babs);

                        if (rabs === v) {
                            h = bb - gg;
                        } else if (gabs === v) {
                            h = (1 / 3) + rr - bb;
                        } else if (babs === v) {
                            h = (2 / 3) + gg - rr;
                        }
                        if (h < 0) {
                            h += 1;
                        }else if (h > 1) {
                            h -= 1;
                        }
                    }
                    return [
                        Math.round(h * 360),
                        percentRoundFn(s * 100),
                        percentRoundFn(v * 100)
                    ]
                }
            }

        </script>

        <footer>
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 850.35 850.35">
                    <path d="M850.35,48.04V802.31c0,26.53-21.51,48.04-48.04,48.04h-171.87c-18.33,0-35.64-8.4-46.98-22.8l-243.52-309.3c-29.93-38.02-91.02-16.85-91.02,31.53v252.55c0,26.52-21.5,48.02-48.02,48.02H48.02c-26.52,0-48.02-21.5-48.02-48.02V48.02C0,21.5,21.5,0,48.02,0H219.9c18.33,0,35.64,8.4,46.99,22.8l243.46,309.07c29.96,38.03,91.08,16.85,91.08-31.56V48.04c0-26.53,21.51-48.04,48.04-48.04h152.85c26.53,0,48.04,21.51,48.04,48.04Z"/>
                </svg>
                <p>Â©NATSKI<br>ENCORE</p>
            </div>
            <span></span>
            <a onclick="parent.loadframe('Privacy Policy');parent.backPage(1)">Privacy Policy</a>
        </footer>

        <div id="SSM" style="display: none;">
            <section>
                <h1><GIS-icon title="gear"></GIS-icon>Sort Settings</h1>
            </section>
        
            <section class="SSMsearch">
                <h1><GIS-icon title="magnify"></GIS-icon>Search</h1>
                <span class="SSMcategory">
                    <input class="SSMinput" type="text" ssminfo="Lets you search for a specific setting" placeholder="Search">
                </span>
            </section>

            <section>
                <h1><GIS-icon title="sparkle"></GIS-icon>Sorting</h1>
                <span class="SSMcategory">
                    <p>Sorting Type</p>
                    <div class="SSMselection SSMinput" ssminfo="changes which method you want to use to sort the pixels">
                        <div class="itemContainer">
                            <span class="SSMheader">
                                Lightness Threshold
                            </span>
                            <span class="SSMitem" value="GREY" onclick="processor.colourSpace('GREY')">
                                Lightness Threshold
                            </span>
                            <span class="SSMitem" value="LAB" onclick="processor.colourSpace('LAB')">
                                Colour Similarity
                            </span>
                            
                        </div>
                    </div>
                </span>
            </section>
            
        
            <section>
                <h1><GIS-icon title="config"></GIS-icon>Threshold</h1>
                <span class="SSMcategory">
                    <p>Lower Bound</p>
                    <input type="range" class="SSMinput" min="0" max="255" value="0" step="1" ssminfo="changes the lower bound used to sort the pixels" onchange="processor.lowerBound(this.value)">
                </span>
                <span class="SSMcategory">
                    <p>Upper Bound</p>
                    <input type="range" class="SSMinput" min="0" max="255" value="255" step="1" ssminfo="changes the upper bound used to sort the pixels" onchange="processor.upperBound(this.value)">
                </span>
            </section>

            <section>
                <h1><GIS-icon title="config"></GIS-icon>Colour Match</h1>
                <span class="SSMcategory">
                    <p>Colour</p>
                    <input type="color" class="SSMinput" ssminfo="changes the colour that will be matched to the pixels when sorting" onchange="changethresh(this, 0)">
                </span>
            </section>
        </div>

        <noscript>
            <h1>javascript is disabled</h1>
            <p>ENCORE.js requires javascript in order to run, please enable javascript</p>
        </noscript>
        <script src="lib/js/ENCORE_NAT.js"></script>
        <script src="lib/js/ENCORE_GIS.js"></script>
        <script>
            GIS_settings = {'style':1}
        </script>
        <script src="lib/js/ENCORE_SSM.js"></script>
        <script>
            SSM_settings = {'style':1}
        </script>
        <script src="lib/js/ENCORE_APF.js"></script>
    </body>
</html>