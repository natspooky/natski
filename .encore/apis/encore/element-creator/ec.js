import IconSystem from"../icon-system/is.js";import encoreConsole from"../dependencies/encoreConsole.js";class ComponentManager{#e;#n;#t;constructor(){this.#e={},this.#n={}}appendGroup(e,n){const t=this.getGroup(n);t?t.layout&&appendChildren(e,t.componentList()):encoreConsole({message:"Error:",error:`The group '${n}' does not exist`})}setGroup(e){if(!this.getGroup(e))return this.#n[e]=new ComponentManager,this;encoreConsole({message:"Assignment Error:",error:`The group '${e}' is already assigned`})}getGroup(e){return this.#n?.[e]}removeGroup(e,n){const t=this.getGroup(e);if(t)return t.removeAllComponents({deleteComponent:!0}),n?.deleteGroup&&delete this.#n[e],this;encoreConsole({message:"Error:",error:`The group '${e}' does not exist`})}#o(e){let n,t=buildComponent(e);return Array.isArray(t)&&(n=document.createDocumentFragment(),t.forEach(e=>{n.appendChild(e)})),{fragment:n,element:t}}setComponent(e,n,t){if(this.getComponent(e))return void encoreConsole({message:"Assignment Error:",error:`The component '${e}' is already assigned`});const{fragment:o,element:r}=this.#o(n,t);return this.#e[e]={json:n,element:r,fragment:o,settings:t},this}getComponent(e){return this.#e?.[e]}getComponents(...e){return[...e].map(e=>this.getComponent(e))}componentList(){return Object.values(this.#e).map(e=>e.fragment??e.element)}removeComponent(e,n){const t=this.getComponent(e)?.element;if(t)return Array.isArray(t)?(console.log(t),t.forEach(e=>{document.body.contains(e)&&e.remove()})):document.body.contains(t)&&t.remove(),n?.deleteComponent&&delete this.#e[e],this;encoreConsole({message:"Error:",error:`The component '${e}' does not exist`})}removeComponents(...e){return[...e].forEach(e=>this.removeComponent(e)),this}removeAllComponents(e){return Object.keys(this.#e).forEach(n=>this.removeComponent(n,e)),this}changeComponentID(e,n){if(e===n)return;const t=this.getComponent(e),o=this.getComponent(n);if(t){if(!o)return this.setComponent(n,t.json),delete this.#e[e],this;encoreConsole({message:"Assignment error:",error:`The component '${n}' is already assigned`})}else encoreConsole({message:"Error:",error:`The component '${e}' does not exist`})}replaceComponent(e,n,t){const o=this.getComponent(e);let r;if("string"==typeof n){if(r=this.getComponent(n),!r)return void encoreConsole({message:"Error:",error:`The component '${e}' does not exist`})}else r=this.#o(n,t);if(o){if(Array.isArray(o.element)){if(!document.body.contains(o.element[0]))return void encoreConsole({message:"Error:",error:`The component '${e}' does not exist`});o[0].element.replaceWith(r.fragment??r.element),o.slice(1).forEach(e=>e.remove())}else{if(!document.body.contains(o.element))return void encoreConsole({message:"Error:",error:`The component '${e}' does not exist`});o.element.replaceWith(r.fragment??r.element)}return this.#e[e]={json:r.json??n,element:r.element,fragment:r.fragment,settings:t},this}encoreConsole({message:"Error:",error:`The component '${e}' does not exist`})}swapComponent(e,n){const t=this.getComponent(e)?.json,o=this.getComponent(n)?.json;if(t){if(o)return this.replaceComponent(e,o),this.replaceComponent(n,t),this;encoreConsole({message:"Error:",error:`The component '${n}' does not exist`})}else encoreConsole({message:"Error:",error:`The component '${e}' does not exist`})}appendComponent(e,n){const t=this.getComponent(n);if(t)return appendChildren(e,t.fragment??t.element),this;encoreConsole({message:"Error:",error:`The component '${n}' does not exist`})}insertComponentBefore(e,n,t){const o=this.getComponent(n);if(o)return insertChildrenBefore(e,o.fragment??o.element,t),this;encoreConsole({message:"Error:",error:`The component '${n}' does not exist`})}get componentCount(){return Object.keys(this.#e).length}get componentIDs(){return Object.keys(this.#e)}set layout(e){this.#t=e}get layout(){return this.#t}}function buildComponent(e){if(Array.isArray(e)){const n=e.filter(e=>checkForKeys(e)||e.nodeType).map(e=>buildComponent(e));return n}if(e&&e.nodeType)return e;let n;if(e.tag){if("text"===e.tag){const n=document.createTextNode(e.text??""),t=document.createComment(""),o=document.createDocumentFragment();return appendChildren(o,[n,t]),o}return n=e.namespace?document.createElementNS(e.namespace,e.tag):document.createElement(e.tag),e.innerHTML&&(n.innerHTML=e.innerHTML),e.classes&&(Array.isArray(e.classes)?e.classes.forEach(e=>{e?.includes(" ")?e.split(" ").forEach(e=>{n.classList.add(e)}):n.classList.add(e)}):e.classes.split(" ").forEach(e=>{n.classList.add(e)})),e.attributes&&Object.entries(e.attributes).forEach(([e,t])=>{checkExists(t)&&n.setAttribute(e,t)}),e.children&&appendChildren(n,buildComponent(e.children)),e.events&&Object.entries(e.events).forEach(([e,t])=>{if(!t)return;if(!checkEvent(e))return void encoreConsole({message:"Support warning:",warn:`Event '${e}' is not supported in current Document`});(Array.isArray(t)?t:[t]).forEach(t=>{t&&t.callback&&(t.target??n).addEventListener(e,functionType(t,n),t.options)})}),e.onAppend&&e.onAppend.callback&&elementAppended(n,e.onAppend.callback,e.onAppend?.options),e.onOrientationChange,e.onInView&&e.onInView.callback&&createIntersect(n,e.onInView.callback,e.onInView?.options),e.onCreate&&("function"!=typeof e.onCreate?encoreConsole({message:"Event error:",error:`The onCreate event value '${e.onCreate}' is not a function`}):e.onCreate(n)),n}encoreConsole({message:"Component error:",error:"Cannot create HTML Node without a tag"})}function appendDataToComponent(e,n){if(e.nodeType&&e.nodeType===Node.ELEMENT_NODE)return n.onAppend&&n.onAppend.callback&&elementAppended(e,n.onAppend.callback,n.onAppend?.options),n.onCreate&&("function"!=typeof n.onCreate?encoreConsole({message:"Event error:",error:`The onCreate event value '${n.onCreate}' is not a function`}):n.onCreate(e)),e;encoreConsole({message:"Type error:",error:"Element provided is not a HTML Node"})}function useEffect(e,n){}function useState(e,n){const t={element:null,state:n,setter:n=>{let o=!1;if("object"==typeof n)o=JSON.stringify(t.state)===JSON.stringify(n);else o=t.state===n;if(o)return;t.state=n;const r=buildComponent(e(t.getter,t.setter));t.element.replaceWith(r),t.element=r},get getter(){return t.state}};return t.element=buildComponent(e(t.getter,t.setter)),t.element}function renderDifference(e,n){if(e.isEqualNode(n))return;[].forEach(({oldNode:e,newNode:n})=>{e.replaceWith(n)})}function checkEvent(e){if("string"!=typeof e||0==e.length)return!1;let n=document.createElement({select:"input",change:"input",submit:"form",reset:"form",error:"img",load:"img",abort:"img"}[e]||"div"),t=(e="on"+e)in n;return t||(n.setAttribute(e,"return;"),t="function"==typeof n[e]),n=null,t}function render(e,n,t){if(window.components)return void encoreConsole({message:"Hydration error:",error:"Only one render call can be made per page"});encoreConsole({message:"Hydrating page"}),t?.useIcons&&new IconSystem,window.components=new ComponentManager;const o=typeof e;let r;if("string"!==o&&"object"!==o)return void encoreConsole({message:"Hydration error:",error:`The root element '${e}' is not an ID or a HTMLElement`});if("string"===o&&(r=document.getElementById(e),!r))return void encoreConsole({message:"Hydration error:",error:`The root element '${e}' does not exist in the document`});if("object"===o&&(r=e,!r.nodeType||r.nodeType!==Node.ELEMENT_NODE))return void encoreConsole({message:"Hydration error:",error:`The root element '${r}' does not exist in the document`});const s=async()=>{try{await(t?.hooks?.before?.());const e=performance.now(),o=await n(),s=window.components.layout,a="content",i=window.components.setComponent(a,o).getComponent(a);s&&window.components.setComponent("layout",s({children:i.fragment??i.element})),window.components.appendComponent(r,s?"layout":a);const c=Math.round(performance.now()-e),m=returnIf(c>0,c,"< 1");encoreConsole({message:`Hydration complete in ${m}ms`})}catch(e){encoreConsole({message:"Hydration failed:"}),console.error(e)}t?.hooks?.after?.()};if(t?.awaitPageLoad&&"complete"!==document.readyState)return window.addEventListener("load",s),void encoreConsole({message:"Awaiting document state 'complete'"});"loading"!==document.readyState?s():window.addEventListener("DOMContentLoaded",s)}function createIntersect(e,n,t){const o={root:t?.root??document,rootMargin:"0px",scrollMargin:"0px",threshold:t?.threshold??[0,.25,.5,.75,1]},r=new IntersectionObserver((o,r)=>{const s=o[0];s.isIntersecting?(t?.clearOnceInView&&r.unobserve(e),n?.visible(e,s)):n?.hidden(e,s)},o);t?.awaitContentLoad?"complete"===document.readyState?r.observe(e):window.addEventListener("load",()=>{r.observe(e)}):r.observe(e)}function useDeprecatedMethodToAppend(e,n){let t;return e.addEventListener("DOMNodeInserted",t=o=>{o.path.length>1&&o.path[o.length-2]instanceof Document&&(e.removeEventListener("DOMNodeInserted",t),n(e))},!1)}function isAppended(e){for(;e.parentNode;)e=e.parentNode;return e instanceof Document}function elementAppended(e,n,t){if(isAppended(e))return void n(e);if(!MutationObserver)return useDeprecatedMethodToAppend(e,n);const o=new MutationObserver(r=>{for(const s of r)if(0!==s.addedNodes.length&&Array.from(s.addedNodes).some(n=>n.contains(e))){if(t?.perminant||o.disconnect(),!t?.awaitPageLoad&&!t?.awaitFontLoad){n(e);break}if(t?.awaitFontLoad){(async()=>{await document.fonts.ready,n(e)})();break}"complete"===document.readyState?n(e):window.addEventListener("load",()=>{n(e)});break}});o.observe(document.body,{childList:!0,subtree:!0})}function functionType({param:e,callback:n,target:t},o){return checkExists(e)?Array.isArray(e)?r=>n(...e.map(e=>checkValue(e,t,o,r))):r=>n(checkValue(e,t,o,r)):n}function checkValue(e,n,t,o){switch(e){case"self":return t;case"parent":return t.parentNode;case"target":if(n)return n;encoreConsole({message:"Type Error:",error:`the target value in '${t}' has not been set`});break;case"event":return o;default:return e}}function checkExists(e){return null!=e}function setFallback(e,n){return returnIf(checkExists(e),e,n)}function returnIf(e,n,t){return e?n:t}function appendChildren(e,n){if(!n)return;(Array.isArray(n)?n:[n]).forEach(n=>{e.appendChild(n)})}function insertChildrenBefore(e,n,t){if(!n)return;(Array.isArray(n)?n:[n]).forEach(n=>{e.insertBefore(n,t)})}function className(e,...n){if(![...n][0]&&1===[...n].length)return e;e=Array.isArray(e)?[...e,...n]:[e,...n];return Array.from(new Set((e=>{const n=[];return e.flat(1/0).filter(Boolean).forEach(e=>{""!==e&&n.push(...e.split(" "))}),n})(e)))}function checkForKeys(e){return 0!==Object.keys(e).length&&e.constructor===Object}export{buildComponent,appendDataToComponent,checkExists,setFallback,returnIf,appendChildren,insertChildrenBefore,className,elementAppended,ComponentManager,checkEvent,render,useState};