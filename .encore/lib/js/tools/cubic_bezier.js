/*!
 * Cubic Bezier
 * Author: NATSKI
 * MIT License
 */
import*as SEC from"https://natski.netlify.app/ENCORE/dependencies/ENCORE_SEC.mjs";import*as DP from"https://natski.netlify.app/ENCORE/dependencies/ENCORE_DP.mjs";import PAS from"https://natski.netlify.app/ENCORE/dependencies/ENCORE_PAS.mjs";var library;class curveGraph{constructor(){this.canvas=document.getElementById("bezier"),this.handleL=document.getElementById("handleL"),this.handleR=document.getElementById("handleR"),this.dataInfo=document.getElementById("data"),this.beforeX=document.getElementById("beforeX"),this.afterX=document.getElementById("afterX"),this.beforeY=document.getElementById("beforeY"),this.afterY=document.getElementById("afterY"),this.outputLeft=document.getElementById("leftCoords"),this.outputRight=document.getElementById("rightCoords"),this.isDown=!1,this.currentAnchor="L",this.clientRect=this.canvas.getBoundingClientRect(),this.ctx=this.canvas.getContext("2d"),this.mobile=DP.userDevice()}init(){this.canvas.height=600,this.canvas.width=300,this.ctx.translate(0,this.canvas.height*(3/4)),this.ctx.scale(this.canvas.width,-this.canvas.height/2),document.getElementsByTagName("INPUT")[0].addEventListener("input",this.setBezier.bind(this)),this.canvas.parentNode.parentNode.addEventListener(this.mobile?"touchstart":"mousedown",this.mobile?this.touchStart.bind(this):this.mouseDown.bind(this)),document.addEventListener(this.mobile?"touchmove":"mousemove",this.inputMove.bind(this)),document.addEventListener(this.mobile?"touchend":"mouseup",this.inputEnd.bind(this))}clamp(t,e){switch(e){case"X":return Math.min(Math.max(t,0),1);case"Y":return Math.min(Math.max(t,-1),2)}}calcYfromMouse(t){return 2*(-t/this.canvas.offsetHeight+3/4)}round(t){return Number(t).toFixed(2)}touchStart(t){let e=this.clamp((t.touches[0].clientX-this.clientRect.left)/this.canvas.offsetWidth,"X"),i=this.clamp(this.calcYfromMouse(t.touches[0].clientY-this.canvas.parentNode.parentNode.parentNode.parentNode.offsetTop+window.scrollY-this.canvas.parentNode.offsetTop-this.canvas.parentNode.parentNode.offsetTop),"Y"),s=this.pythag(this.handleL.dataset.positionX-e,this.handleL.dataset.positionY-i),a=this.pythag(this.handleR.dataset.positionX-e,this.handleR.dataset.positionY-i);(s<.12||a<.12)&&t.cancelable&&(t.preventDefault(),this.currentAnchor=s<a?"L":"R",this.isDown=!0,this.setBefValue(this.currentAnchor),this.dataInfo.classList.add("visible"))}mouseDown(t){let e=this.clamp((t.clientX-this.clientRect.left)/this.canvas.offsetWidth,"X"),i=this.clamp(this.calcYfromMouse(t.clientY-this.canvas.parentNode.parentNode.parentNode.parentNode.offsetTop+window.scrollY-this.canvas.parentNode.offsetTop-this.canvas.parentNode.parentNode.offsetTop),"Y");this.pythag(this.handleL.dataset.positionX-e,this.handleL.dataset.positionY-i)<this.pythag(this.handleR.dataset.positionX-e,this.handleR.dataset.positionY-i)?this.currentAnchor="L":this.currentAnchor="R",this.isDown=!0,this.setBefValue(this.currentAnchor),this.dataInfo.classList.add("visible")}inputMove(t){this.isDown&&(this.loadBezierData(this.currentAnchor,{x:this.clamp(((this.mobile?t.changedTouches[0].clientX:t.clientX)-this.canvas.parentNode.offsetLeft-20)/this.canvas.offsetWidth,"X"),y:this.clamp(this.calcYfromMouse((this.mobile?t.changedTouches[0].clientY:t.clientY)-this.canvas.parentNode.parentNode.parentNode.parentNode.offsetTop+window.scrollY-this.canvas.parentNode.offsetTop-this.canvas.parentNode.parentNode.offsetTop),"Y")}),this.setAftValue(this.currentAnchor))}inputEnd(){this.isDown&&(this.outputLeft.innerHTML=`${this.round(this.handleL.dataset.positionX)}, ${this.round(this.handleL.dataset.positionY)}`,this.outputRight.innerHTML=`${this.round(this.handleR.dataset.positionX)}, ${this.round(this.handleR.dataset.positionY)}`,this.isDown=!1,this.dataInfo.classList.remove("visible"),library.checkActive(),library.setStorage())}drawAnchor(){this.ctx.lineWidth=.01,this.ctx.strokeStyle="#000000",this.ctx.beginPath(),this.ctx.moveTo(0,0),this.ctx.lineTo(this.handleL.dataset.positionX,this.handleL.dataset.positionY),this.ctx.moveTo(1,1),this.ctx.lineTo(this.handleR.dataset.positionX,this.handleR.dataset.positionY),this.ctx.stroke()}getBezierData(){return{l:{x:this.handleL.dataset.positionX,y:this.handleL.dataset.positionY},r:{x:this.handleR.dataset.positionX,y:this.handleR.dataset.positionY}}}drawCurve(){this.ctx.lineWidth=.03,this.ctx.strokeStyle="#e6edf3",this.ctx.beginPath(),this.ctx.moveTo(0,0),this.ctx.bezierCurveTo(this.handleL.dataset.positionX,this.handleL.dataset.positionY,this.handleR.dataset.positionX,this.handleR.dataset.positionY,1,1),this.ctx.stroke()}setBefValue(t){switch(t){case"L":this.beforeX.innerHMTL=`${this.percentageCalc(this.handleL.dataset.positionX)}%`,this.beforeY.innerHTML=`${this.percentageCalc(this.handleL.dataset.positionY)}%`;break;case"R":this.beforeX.innerHTML=`${this.percentageCalc(this.handleR.dataset.positionX)}%`,this.beforeY.innerHTML=`${this.percentageCalc(this.handleR.dataset.positionY)}%`}}setAftValue(t){switch(t){case"L":this.afterX.innerHTML=`${this.percentageCalc(this.handleL.dataset.positionX)}%`,this.afterY.innerHTML=`${this.percentageCalc(this.handleL.dataset.positionY)}%`;break;case"R":this.afterX.innerHTML=`${this.percentageCalc(this.handleR.dataset.positionX)}%`,this.afterY.innerHTML=`${this.percentageCalc(this.handleR.dataset.positionY)}%`}}percentageCalc(t){return(100*Number(t)).toFixed(0)}draw(){this.ctx.clearRect(0,-1,1,3),this.drawAnchor(),this.drawCurve()}pythag(t,e){return Math.sqrt(t*t+e*e)}changeAnchor(t,e){switch(t){case"L":this.handleL.dataset.positionX=e.x,this.handleL.dataset.positionY=e.y;break;case"R":this.handleR.dataset.positionX=e.x,this.handleR.dataset.positionY=e.y}}loadBezierData(t,e){this.changeHandlesClamped(t,e),this.changeAnchor(t,e),this.draw()}loadDualBezierData(t){this.loadBezierData("L",t.l),this.loadBezierData("R",t.r)}changeHandlesClamped(t,e){switch(t){case"L":this.handleL.style.left=e.x*this.canvas.offsetWidth+"px",this.handleL.style.top=(-e.y/2+3/4)*this.canvas.offsetHeight+"px";break;case"R":this.handleR.style.left=e.x*this.canvas.offsetWidth+"px",this.handleR.style.top=(-e.y/2+3/4)*this.canvas.offsetHeight+"px"}}setBezier(t){let e=t.srcElement.value.match(/(\d+)(\.\d+)*/g)||[];e.length>=4&&(this.loadBezierData("L",{x:this.clamp(e[0],"X"),y:this.clamp(e[1],"Y")}),this.loadBezierData("R",{x:this.clamp(e[2],"X"),y:this.clamp(e[3],"Y")}),this.setAftValue("L"),this.setBefValue("R"))}}class miniCurve{constructor(t,e){this.bezierValues=t,this.canvas=e.children[0],this.button=e,this.ctx=canvas.getContext("2d")}init(){this.canvas.height=this.canvas.offsetHeight,this.canvas.width=this.canvas.offsetWidth,this.ctx.scale(this.canvas.width/2,-this.canvas.height/2),this.ctx.translate(.5,-1.5),this.draw(),setTimeout(()=>{this.button.classList.add("active")},10)}setSelected(t){t?this.button.classList.add("selected"):this.button.classList.remove("selected")}setCurveData(t){this.bezierValues=t}getCurveData(){return this.bezierValues}getCurveButton(){return this.button}draw(){this.ctx.clearRect(-1,-1,3,3),this.ctx.lineWidth=.09,this.ctx.lineCap="round",this.ctx.strokeStyle="#e6edf3",this.ctx.beginPath(),this.ctx.moveTo(0,0),this.ctx.bezierCurveTo(this.bezierValues.l.x,this.bezierValues.l.y,this.bezierValues.r.x,this.bezierValues.r.y,1,1),this.ctx.stroke()}}class curveLibrary{constructor(){this.libraryElement=document.getElementById("library"),this.library=[],this.bezierCurve=new curveGraph,this.bezierCurve.init(),this.addButton=document.getElementById("addLibrary"),this.popup=new PAS,this.activeCurve}init(){this.bezierCurve.draw(),this.loadStorage(),this.addButton.addEventListener("click",()=>{this.createItem(this.bezierCurve.getBezierData()),this.setStorage()})}addPopup(t){this.popup.add(t)}loadStorage(){let t=localStorage.getItem("curveLibrary");if(t&&t.split(",").length>=4){t=t.split(",");for(let e=0;e<t.length;e+=4)this.createItem({l:{x:t[e],y:t[e+1]},r:{x:t[e+2],y:t[e+3]}})}}generateStorage(){let t=[];return this.library.forEach(e=>{let i=e.getCurveData();t.push([i.l.x,i.l.y,i.r.x,i.r.y])}),t}setStorage(){localStorage.setItem("curveLibrary",this.generateStorage())}selectCurve(t){this.bezierCurve.loadDualBezierData(t.getCurveData());let e=t.getCurveButton();for(let i=0;i<this.library.length;i++)e==this.library[i].getCurveButton()?(this.library[i].setSelected(!0),this.activeCurve=t,console.log(t.getCurveData())):this.library[i].setSelected(!1)}removeCurve(t){for(let e=0;e<this.library.length;e++)if(t.parentNode==this.library[e].getCurveButton()){t.parentNode.remove(),this.library.splice(e,1);break}this.setStorage()}checkActive(){this.activeCurve&&(this.activeCurve.setCurveData(this.bezierCurve.getBezierData()),this.activeCurve.draw())}createItem(t){let e=new miniCurve(t);e.init(),this.libraryElement.appendChild(SEC.buildComponent({tag:"span",classes:["library-button"],children:[{tag:"canvas"},{tag:"span",classes:["click-panel"],events:{click:{callback:this.selectCurve.bind(this),param:e}}},{tag:"div",classes:["remove-button"],events:{callback:this.removeCurve.bind(this),param:"self"},children:[{tag:"IS",attributes:{name:"cross"}}]}]})),this.library.push(e)}export(){navigator.clipboard.writeText(this.generateStorage())}import(){}}window.addEventListener("DOMContentLoaded",function(){let t=new curveLibrary;t.init();for(const e of document.getElementsByClassName("copy-box"))e.addEventListener("click",function(){navigator.clipboard.writeText(this.innerText),t.addPopup({message:"bezier copied to clipboard",icon:"copy",duration:2e3,noRepeat:!0})})});