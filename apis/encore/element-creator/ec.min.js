/* -----------------------------------------------
/* Author : NATSKI - natski.dev
/* MIT license : https://opensource.org/license/MIT
/* GitHub : https://github.com/natspooky/encore
/* How to use? : Check the GitHub README or visit https://natski.dev/apis/encore/element-creator
/* ----------------------------------------------- */

import e from"../icon-system/is.min.js";import n from"../dependencies/encoreConsole.js";function jsonElementify(e){if(e&&e.nodeType)return e;if(Array.isArray(e)){let n=[];return e.forEach(e=>{(checkForKeys(e)||e.nodeType)&&n.push(jsonElementify(e))}),n}let t;if(e.tag){if("text"===e.tag)return document.createTextNode(e.text?e.text:"");t=e.namespace?document.createElementNS(e.namespace,e.tag):document.createElement(e.tag)}return e.innerHTML&&(t.innerHTML=e.innerHTML),e.classes&&(Array.isArray(e.classes)?e.classes.forEach(n=>{n.includes(" ")?e.classes.split(" ").forEach(e=>{t.classList.add(e)}):t.classList.add(n)}):e.classes.split(" ").forEach(e=>{t.classList.add(e)})),e.attributes&&Object.entries(e.attributes).forEach(([e,n])=>{checkExists(n)&&t.setAttribute(e,n)}),e.children&&appendChildren(t,jsonElementify(e.children)),e.events&&Object.entries(e.events).forEach(([e,n])=>{if(n){if(!checkEvent(e)){console.warn(`Event '${e}' is not supported on:`,t);return}Array.isArray(n)?n.forEach(n=>{t.addEventListener(e,functionType(n,t),n.options)}):t.addEventListener(e,functionType(n,t),n.options)}}),e.onAppend&&elementAppended(t,e.onAppend),e.onCreation?.(t),t}function checkEvent(e){if("string"!=typeof e||0==e.length)return!1;let n=document.createElement({select:"input",change:"input",submit:"form",reset:"form",error:"img",load:"img",abort:"img"}[e]||"div"),t=(e="on"+e)in n;return t||(n.setAttribute(e,"return;"),t="function"==typeof n[e]),n=null,t}function render(t,r,o){if(window.EncoreRender){n({message:"Hydration Cancelled:",error:Error("Only one render call can be made per page")});return}n({message:"Hydrating"}),window.EncoreRender=!0,o?.useIcons&&!window.IconSystem&&new e;let s=new ComponentManager,i=typeof t,a;if("string"!==i&&"object"!==i){n({message:"Hydration Cancelled:",error:TypeError("Provided root element is not an element ID or a HTMLElement")});return}if("string"===i&&!(a=document.getElementById(t))){n({message:"Hydration cancelled:",error:Error("Provided root element does not exist in the document")});return}"object"===i&&(a=t);let l=async e=>{try{let t=performance.now(),o=await r(e);e.setComponent("render",o);let s=e.getLayout();appendChildren(a,s?jsonElementify(s({children:e.getComponent("render").element})):e.getComponent("render").element);let i=Math.round(performance.now()-t);n({message:`Render complete in ${i>0?i:"< 1"}ms`}),i>500&&n({message:"Warning:",error:"Render time high :("})}catch(l){n({message:"Hydration failed:"}),console.error(l)}};if("loading"===document.readyState){window.addEventListener("DOMContentLoaded",()=>{l(s)});return}l(s)}function jsonElementAppend(e,n){if(!(e.nodeType&&e.nodeType===Node.ELEMENT_NODE))throw TypeError("Element provided is not a HTML Node");return n.innerHTML&&(e.innerHTML=n.innerHTML),n.classes&&(Array.isArray(n.classes)?n.classes.forEach(t=>{t.includes(" ")?n.classes.split(" ").forEach(n=>{e.classList.add(n)}):e.classList.add(t)}):n.classes.split(" ").forEach(n=>{e.classList.add(n)})),n.attributes&&Object.entries(n.attributes).forEach(([n,t])=>{checkExists(t)&&e.setAttribute(n,t)}),n.children&&appendChildren(e,jsonElementify(n.children)),n.events&&Object.entries(n.events).forEach(([n,t])=>{t&&(Array.isArray(t)?t.forEach(t=>{e.addEventListener(n,functionType(t,e),t.options)}):e.addEventListener(n,functionType(t,e),t.options))}),n.onAppend&&elementAppended(e,n.onAppend),e}function useDeprecatedMethod(e,n){let t;return e.addEventListener("DOMNodeInserted",t=r=>{r.path.length>1&&r.path[r.length-2]instanceof Document&&(e.removeEventListener("DOMNodeInserted",t),n(e))},!1)}function isAppended(e){for(;e.parentNode;)e=e.parentNode;return e instanceof Document}function elementAppended(e,n){if(isAppended(e)){n(e);return}if(!MutationObserver)return useDeprecatedMethod(e,n);let t=new MutationObserver(r=>{for(let o of r)if(0!==o.addedNodes.length&&0!==Array.from(o.addedNodes).filter(n=>n.contains(e)).length){t.disconnect(),n(e);break}});t.observe(document.body,{childList:!0,subtree:!0})}function functionType(e,n){return checkExists(e.param)?Array.isArray(e.param)&&e.param.length>1?"self"===e.param[0]?()=>e.callback(n,...e.param.slice(1)):"event"===e.param[0]?n=>e.callback(n,...e.param.slice(1)):()=>e.callback(...e.param):(Array.isArray(e.param)&&(e.param=e.param[0]),"self"===e.param)?()=>e.callback(n):"event"===e.param?n=>e.callback(n):()=>e.callback(e.param):()=>e.callback()}function checkExists(e){return null!=e}function setFallback(e,n){return checkExists(e)?e:n}function appendChildren(e,n){if(n){if(Array.isArray(n))for(let t of n)e.appendChild(t);else e.appendChild(n);return e}}function insertChildrenBefore(e,n,t){if(Array.isArray(n))for(let r of n)e.insertBefore(r,t);else e.insertBefore(n,t)}function className(e,...n){return[...n][0]&&(Array.isArray(e)||(e=e.split(" ")),[...n].forEach(n=>{Array.isArray(n)||(n=n.split(" ")),e.push(...n)})),e}function checkForKeys(e){return 0!==Object.keys(e).length&&e.constructor===Object}class ComponentManager{#a;#b;constructor(){this.#a={}}setComponent(e,n,t){if(this.getComponent(e))throw Error(`Component ID "${e}" is already assigned`);let r=jsonElementify(n);this.#a[e]={json:n,element:r,type:Array.isArray(r)?"Element Array":"Element",settings:t}}getComponent(e){return this.#a?.[e]}getComponents(...e){return[...e].map(e=>this.getComponent(e))}getAllComponents(){return Object.entries(this.#a).map(([,e])=>e)}setLayout(e){this.#b=e}getLayout(){return this.#b}removeComponent(e){let n=this.getComponent(e).element;if(!n)throw Error(`Component ID "${e}" does not exist`);!Array.isArray(n)&&document.body.contains(n)?n.remove():n.forEach(e=>{document.body.contains(e)&&e.remove()}),delete this.#a[e]}removeComponents(...e){[...e].forEach(e=>this.removeComponent(e))}removeAllComponents(){Object.entries(this.#a).forEach(([e])=>this.removeComponent(e))}changeComponentID(e,n){if(e===n)return;let t=this.getComponent(e),r=this.getComponent(n);if(!t)throw Error(`Component ID "${e}" does not exist`);if(r)throw Error(`Component ID "${n}" is already assigned`);this.setComponent(n,t.json),delete this.#a[e]}replaceComponent(e,n){let t=this.getComponent(e),r=jsonElementify(n);if(!t){this.setComponent(e,n);return}document.body.contains(t.element)&&(console.log(t.element),Array.isArray(t.element)?[...t.element].forEach(e=>{e.replace(...r)}):t.element.replaceWith(r)),this.#a[e]={json:n,element:r,type:Array.isArray(r)?"Element Array":"Element"}}appendComponent(e,n){let t=this.getComponent(n).element;if(!t)throw Error(`Component ID "${n}" does not exist`);appendChildren(e,t)}insertComponentBefore(e,n,t){let r=this.getComponent(n).element;if(!r)throw Error(`Component ID "${n}" does not exist`);insertChildrenBefore(e,r,t)}get componentCount(){return Object.entries(this.#a).length}get componentIDsByType(){let e=[],n=[];return Object.entries(this.#a).forEach(([t,r])=>{"Element"===r.type?e.push(t):n.push(t)}),{Element:e,"Element Array":n}}get componentIDs(){return Object.entries(this.#a).map(([e])=>e)}}export{jsonElementify,jsonElementAppend,checkExists,setFallback,appendChildren,insertChildrenBefore,className,elementAppended,ComponentManager,checkEvent,render};