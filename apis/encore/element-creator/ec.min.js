/* -----------------------------------------------
/* Author : NATSKI - natski.dev
/* MIT license : https://opensource.org/license/MIT
/* GitHub : https://github.com/natspooky/encore
/* How to use? : Check the GitHub README or visit https://natski.dev/apis/encore/element-creator
/* ----------------------------------------------- */

import e from"../icon-system/is.min.js";import t from"../dependencies/encoreConsole.js";class ComponentManager{#a;#b;#c;constructor(){this.#a={},this.#b={}}appendGroup(e,n){let r=this.getGroup(n);if(!r){t({message:"Error:",error:`The group '${n}' does not exist`});return}r.layout&&appendChildren(e,r.componentList())}setGroup(e){if(this.getGroup(e)){t({message:"Assignment Error:",error:`The group '${e}' is already assigned`});return}return this.#b[e]=new ComponentManager,this}getGroup(e){return this.#b?.[e]}removeGroup(e,n){let r=this.getGroup(e);if(!r){t({message:"Error:",error:`The group '${e}' does not exist`});return}return r.removeAllComponents({deleteComponent:!0}),n?.deleteGroup&&delete this.#b[e],this}#d(n){let r,o=buildComponent(n);return Array.isArray(o)&&(r=document.createDocumentFragment(),o.forEach(e=>{r.appendChild(e)})),{fragment:r,element:o}}setComponent(e,n,r){if(this.getComponent(e)){t({message:"Assignment Error:",error:`The component '${e}' is already assigned`});return}let{fragment:o,element:s}=this.#d(n,r);return this.#a[e]={json:n,element:s,fragment:o,settings:r},this}getComponent(e){return this.#a?.[e]}getComponents(...e){return[...e].map(e=>this.getComponent(e))}componentList(){return Object.entries(this.#a).map(([,e])=>e.fragment??e.element)}removeComponent(e,n){let r=this.getComponent(e)?.element;if(!r){t({message:"Error:",error:`The component '${e}' does not exist`});return}return Array.isArray(r)?(console.log(r),r.forEach(e=>{document.body.contains(e)&&e.remove()})):document.body.contains(r)&&r.remove(),n?.deleteComponent&&delete this.#a[e],this}removeComponents(...e){return[...e].forEach(e=>this.removeComponent(e)),this}removeAllComponents(e){return Object.entries(this.#a).forEach(([t])=>this.removeComponent(t,e)),this}changeComponentID(e,n){if(e===n)return;let r=this.getComponent(e),o=this.getComponent(n);if(!r){t({message:"Error:",error:`The component '${e}' does not exist`});return}if(o){t({message:"Assignment error:",error:`The component '${n}' is already assigned`});return}return this.setComponent(n,r.json),delete this.#a[e],this}replaceComponent(e,n,r){let o=this.getComponent(e),s;if("string"==typeof n){if(!(s=this.getComponent(n))){t({message:"Error:",error:`The component '${e}' does not exist`});return}}else s=this.#d(n,r);if(!o){t({message:"Error:",error:`The component '${e}' does not exist`});return}if(Array.isArray(o.element)){if(!document.body.contains(o.element[0])){t({message:"Error:",error:`The component '${e}' does not exist`});return}o.element.forEach(e=>{e.replaceWith(s.fragment??s.element)})}else{if(!document.body.contains(o.element)){t({message:"Error:",error:`The component '${e}' does not exist`});return}o.element.replaceWith(s.fragment??s.element)}return this.#a[e]={json:s.json??n,element:s.element,fragment:s.fragment,settings:r},this}swapComponent(e,n){let r=this.getComponent(e)?.json,o=this.getComponent(n)?.json;if(!r){t({message:"Error:",error:`The component '${e}' does not exist`});return}if(!o){t({message:"Error:",error:`The component '${n}' does not exist`});return}return this.replaceComponent(e,o),this.replaceComponent(n,r),this}appendComponent(e,n){let r=this.getComponent(n);if(!r){t({message:"Error:",error:`The component '${n}' does not exist`});return}return appendChildren(e,r.fragment??r.element),this}insertComponentBefore(e,n,r){let o=this.getComponent(n);if(!o){t({message:"Error:",error:`The component '${n}' does not exist`});return}return insertChildrenBefore(e,o.fragment??o.element,r),this}get componentCount(){return Object.entries(this.#a).length}get componentIDs(){return Object.entries(this.#a).map(([e])=>e)}set layout(e){this.#c=e}get layout(){return this.#c}}function buildComponent(e){if(Array.isArray(e)){let n=[];return e.forEach(e=>{(checkForKeys(e)||e.nodeType)&&n.push(buildComponent(e))}),n}if(e&&e.nodeType)return e;let r;if(e.tag){if("text"===e.tag)return document.createTextNode(e.text??"");r=e.namespace?document.createElementNS(e.namespace,e.tag):document.createElement(e.tag)}return e.innerHTML&&(r.innerHTML=e.innerHTML),e.classes&&(Array.isArray(e.classes)?e.classes.forEach(t=>{t.includes(" ")?e.classes.split(" ").forEach(e=>{r.classList.add(e)}):r.classList.add(t)}):e.classes.split(" ").forEach(e=>{r.classList.add(e)})),e.attributes&&Object.entries(e.attributes).forEach(([e,t])=>{checkExists(t)&&r.setAttribute(e,t)}),e.children&&appendChildren(r,buildComponent(e.children)),e.events&&Object.entries(e.events).forEach(([e,n])=>{if(n){if(!checkEvent(e)){t({message:"Support warning:",warn:`Event '${e}' is not supported in current Document`});return}Array.isArray(n)?n.forEach(t=>{(t?.target??r).addEventListener(e,functionType(t,r),t.options)}):(n?.target??r).addEventListener(e,functionType(n,r),n.options)}}),e.onAppend&&e.onAppend.callback&&elementAppended(r,e.onAppend.callback,e.onAppend?.options),e.onInView,e.onCreate&&("function"!=typeof e.onCreate?t({message:"Event error:",error:`The onCreate event value '${e.onCreate}' is not a function`}):e.onCreate(r)),r}function appendDataToComponent(e,n){if(!(e.nodeType&&e.nodeType===Node.ELEMENT_NODE)){t({message:"Type error:",error:"Element provided is not a HTML Node"});return}return n.onAppend&&n.onAppend.callback&&elementAppended(e,n.onAppend.callback,n.onAppend?.options),n.onCreate&&("function"!=typeof n.onCreate?t({message:"Event error:",error:`The onCreate event value '${n.onCreate}' is not a function`}):n.onCreate(e)),e}function checkEvent(e){if("string"!=typeof e||0==e.length)return!1;let t=document.createElement({select:"input",change:"input",submit:"form",reset:"form",error:"img",load:"img",abort:"img"}[e]||"div"),n=(e="on"+e)in t;return n||(t.setAttribute(e,"return;"),n="function"==typeof t[e]),t=null,n}function render(n,r,o){if(window.EncoreRender){t({message:"Hydration error:",error:"Only one render call can be made per page"});return}window.EncoreRender=!0,t({message:"Hydrating page"}),o?.useIcons&&new e;let s=new ComponentManager,i=typeof n,a;if("string"!==i&&"object"!==i){t({message:"Hydration error:",error:`The root element '${n}' is not an ID or a HTMLElement`});return}if("string"===i&&!(a=document.getElementById(n))){t({message:"Hydration error:",error:`The root element '${n}' does not exist in the document`});return}if("object"===i&&!((a=n).nodeType&&a.nodeType===Node.ELEMENT_NODE)){t({message:"Hydration error:",error:`The root element '${a}' does not exist in the document`});return}let p=async e=>{try{let n=performance.now(),o=e.setGroup("page").getGroup("page"),s=await r(o),i=o.layout,p="content",m=o.setComponent(p,s).getComponent(p);i&&o.setComponent("layout",i({children:m.fragment??m.element})),o.appendComponent(a,i?"layout":p);let c=Math.round(performance.now()-n);t({message:`Hydration complete in ${c>0?c:"< 1"}ms`})}catch(d){t({message:"Hydration failed:"}),console.error(d)}};if("loading"===document.readyState){window.addEventListener("DOMContentLoaded",()=>{p(s)});return}"complete"===document.readyState&&t({message:"Performance warning:",warn:"Rendering after document load is unadvised"}),p(s)}function isIntersecting(e,t,n){n?.awaitResourceLoad}function useDeprecatedMethodToAppend(e,t){let n;return e.addEventListener("DOMNodeInserted",n=r=>{r.path.length>1&&r.path[r.length-2]instanceof Document&&(e.removeEventListener("DOMNodeInserted",n),t(e))},!1)}function isAppended(e){for(;e.parentNode;)e=e.parentNode;return e instanceof Document}function elementAppended(e,t,n){if(isAppended(e)){t(e);return}if(!MutationObserver)return useDeprecatedMethodToAppend(e,t);let r=new MutationObserver(o=>{for(let s of o)if(0!==s.addedNodes.length&&0!==Array.from(s.addedNodes).filter(t=>t.contains(e)).length){if(n?.perminant||r.disconnect(),!n?.awaitContentLoad){t(e);break}"complete"===document.readyState?t(e):window.addEventListener("load",()=>{t(e)});break}});r.observe(document.body,{childList:!0,subtree:!0})}function functionType({param:e,callback:t,target:n},r){return checkExists(e)?Array.isArray(e)?o=>t(...e.map(e=>checkValue(e,n,r,o))):o=>t(checkValue(e,n,r,o)):t}function checkValue(e,n,r,o){switch(e){case"self":return r;case"parent":return r.parentNode;case"target":if(n)return n;t({message:"Type Error:",error:`the target value in '${r}' has not been set`});break;case"event":return o;default:return e}}function checkExists(e){return null!=e}function setFallback(e,t){return checkExists(e)?e:t}function appendChildren(e,t){if(t){if(Array.isArray(t))for(let n of t)e.appendChild(n);else e.appendChild(t);return e}}function insertChildrenBefore(e,t,n){if(Array.isArray(t))for(let r of t)e.insertBefore(r,n);else e.insertBefore(t,n)}function className(e,...t){return[...t][0]&&(Array.isArray(e)||(e=e.split(" ")),[...t].forEach(t=>{Array.isArray(t)||(t=t.split(" ")),e.push(...t)})),e}function checkForKeys(e){return 0!==Object.keys(e).length&&e.constructor===Object}export{buildComponent,appendDataToComponent,checkExists,setFallback,appendChildren,insertChildrenBefore,className,elementAppended,ComponentManager,checkEvent,render};