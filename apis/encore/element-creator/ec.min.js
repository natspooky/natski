/* -----------------------------------------------
/* Author : NATSKI - natski.dev
/* MIT license : https://opensource.org/license/MIT
/* GitHub : https://github.com/natspooky/encore
/* How to use? : Check the GitHub README or visit https://natski.dev/apis/encore/element-creator
/* ----------------------------------------------- */

import e from"../icon-system/is.min.js";import n from"../dependencies/encoreConsole.js";function buildComponent(e){if(Array.isArray(e)){let t=[];return e.forEach(e=>{(checkForKeys(e)||e.nodeType)&&t.push(buildComponent(e))}),t}if(e&&e.nodeType)return e;let r;if(e.tag){if("text"===e.tag)return document.createTextNode(e.text?e.text:"");r=e.namespace?document.createElementNS(e.namespace,e.tag):document.createElement(e.tag)}return e.innerHTML&&(r.innerHTML=e.innerHTML),e.classes&&(Array.isArray(e.classes)?e.classes.forEach(n=>{n.includes(" ")?e.classes.split(" ").forEach(e=>{r.classList.add(e)}):r.classList.add(n)}):e.classes.split(" ").forEach(e=>{r.classList.add(e)})),e.attributes&&Object.entries(e.attributes).forEach(([e,n])=>{checkExists(n)&&r.setAttribute(e,n)}),e.children&&appendChildren(r,buildComponent(e.children)),e.events&&Object.entries(e.events).forEach(([e,t])=>{if(t){if(!checkEvent(e)){n({message:"Support warning:",warn:`Event '${e}' is not supported in current Document`});return}Array.isArray(t)?t.forEach(n=>{r.addEventListener(e,functionType(n,r),n.options)}):r.addEventListener(e,functionType(t,r),t.options)}}),e.onAppend&&("function"!=typeof e.onAppend?n({message:"Event error:",error:`The onAppend event value '${e.onAppend}' is not a function`}):elementAppended(r,e.onAppend)),e.onCreate&&("function"!=typeof e.onCreate?n({message:"Event error:",error:`The onCreate event value '${e.onCreate}' is not a function`}):e.onCreate(r)),r}function checkEvent(e){if("string"!=typeof e||0==e.length)return!1;let n=document.createElement({select:"input",change:"input",submit:"form",reset:"form",error:"img",load:"img",abort:"img"}[e]||"div"),t=(e="on"+e)in n;return t||(n.setAttribute(e,"return;"),t="function"==typeof n[e]),n=null,t}function detectChange(e,t){if(!window.EncoreRender){n({message:"Error:",error:""});return}if(!(e||"function"==typeof e)||!(t||Array.isArray(t))){n({message:"Type error:",error:""});return}if(t.length<=0){e();return}listenArray(t,e)}function keepState(e){let n={data:e??void 0};return[function e(){return n.data},function e(t){n.data=t}]}function listenArray(e,n){["pop","push","reverse","shift","unshift","splice","sort"].forEach(t=>{e[t]=function(){var r=Array.prototype[t].apply(e,arguments);return n.apply(e,arguments),r}})}function render(t,r,o){if(window.EncoreRender){n({message:"Hydration error:",error:"Only one render call can be made per page"});return}window.EncoreRender=!0,n({message:"Hydrating page"}),o?.useIcons&&new e;let s=new ComponentManager,i=typeof t,a;if("string"!==i&&"object"!==i){n({message:"Hydration error:",error:`The root element '${t}' is not an ID or a HTMLElement`});return}if("string"===i&&!(a=document.getElementById(t))){n({message:"Hydration error:",error:`The root element '${t}' does not exist in the document`});return}if("object"===i&&!((a=t).nodeType&&a.nodeType===Node.ELEMENT_NODE)){n({message:"Hydration error:",error:`The root element '${a}' does not exist in the document`});return}let p=async e=>{try{let t=performance.now();e.setGroup("page").getGroup("page");let o=await r(e),s="content",i=e.layout,p=e.setComponent(s,o).getComponent(s);i&&e.setComponent("layout",i({children:p.fragment??p.element})),e.appendComponent(a,i?"layout":s);let c=Math.round(performance.now()-t);n({message:`Hydration complete in ${c>0?c:"< 1"}ms`}),c>500&&n({message:"Performance warning:",warn:`${c}ms. :(`})}catch(m){n({message:"Hydration failed:"}),console.error(m)}};if("loading"===document.readyState){window.addEventListener("DOMContentLoaded",()=>{p(s)});return}"complete"===document.readyState&&n({message:"Performance warning:",warn:"Rendering after document load is unadvised"}),p(s)}function jsonElementAppend(e,t){if(!(e.nodeType&&e.nodeType===Node.ELEMENT_NODE)){n({message:"Type error:",error:"Element provided is not a HTML Node"});return}if(t.innerHTML&&(e.innerHTML=t.innerHTML),t.classes&&(Array.isArray(t.classes)?t.classes.forEach(n=>{n.includes(" ")?t.classes.split(" ").forEach(n=>{e.classList.add(n)}):e.classList.add(n)}):t.classes.split(" ").forEach(n=>{e.classList.add(n)})),t.attributes&&Object.entries(t.attributes).forEach(([n,t])=>{checkExists(t)&&e.setAttribute(n,t)}),t.children&&appendChildren(e,buildComponent(t.children)),t.events&&Object.entries(t.events).forEach(([n,t])=>{t&&(Array.isArray(t)?t.forEach(t=>{e.addEventListener(n,functionType(t,e),t.options)}):e.addEventListener(n,functionType(t,e),t.options))}),t.onAppend){if("function"!=typeof t.onAppend){n({message:"Event error:",error:`The onAppend event value '${t.onAppend}' is not a function`});return}elementAppended(e,t.onAppend)}if(t.onCreate){if("function"!=typeof t.onCreate){n({message:"Event error:",error:`The onCreate event value '${t.onCreate}' is not a function`});return}t.onCreate(e)}return e}function useDeprecatedMethod(e,n){let t;return e.addEventListener("DOMNodeInserted",t=r=>{r.path.length>1&&r.path[r.length-2]instanceof Document&&(e.removeEventListener("DOMNodeInserted",t),n(e))},!1)}function isAppended(e){for(;e.parentNode;)e=e.parentNode;return e instanceof Document}function elementAppended(e,n){if(isAppended(e)){n(e);return}if(!MutationObserver)return useDeprecatedMethod(e,n);let t=new MutationObserver(r=>{for(let o of r)if(0!==o.addedNodes.length&&0!==Array.from(o.addedNodes).filter(n=>n.contains(e)).length){t.disconnect(),n(e);break}});t.observe(document.body,{childList:!0,subtree:!0})}function functionType(e,n){return checkExists(e.param)?Array.isArray(e.param)&&e.param.length>1?"self"===e.param[0]?()=>e.callback(n,...e.param.slice(1)):"event"===e.param[0]?n=>e.callback(n,...e.param.slice(1)):()=>e.callback(...e.param):(Array.isArray(e.param)&&(e.param=e.param[0]),"self"===e.param)?()=>e.callback(n):"event"===e.param?n=>e.callback(n):()=>e.callback(e.param):()=>e.callback()}function checkExists(e){return null!=e}function setFallback(e,n){return checkExists(e)?e:n}function appendChildren(e,n){if(n){if(Array.isArray(n))for(let t of n)e.appendChild(t);else e.appendChild(n);return e}}function insertChildrenBefore(e,n,t){if(Array.isArray(n))for(let r of n)e.insertBefore(r,t);else e.insertBefore(n,t)}function className(e,...n){return[...n][0]&&(Array.isArray(e)||(e=e.split(" ")),[...n].forEach(n=>{Array.isArray(n)||(n=n.split(" ")),e.push(...n)})),e}function checkForKeys(e){return 0!==Object.keys(e).length&&e.constructor===Object}class ComponentManager{#a;#b;#c;constructor(){this.#a={},this.#b={}}appendGroup(e,t){let r=this.getGroup(t);if(!r){n({message:"Error:",error:`The group '${t}' does not exist`});return}r.layout&&appendChildren(e,r.componentList())}setGroup(e){if(this.getGroup(e)){n({message:"Assignment Error:",error:`The group '${e}' is already assigned`});return}return this.#b[e]=new ComponentManager,this}getGroup(e){return this.#b?.[e]}removeGroup(e,t){let r=this.getGroup(e);if(!r){n({message:"Error:",error:`The group '${e}' does not exist`});return}return r.removeAllComponents({deleteComponent:!0}),t?.deleteGroup&&delete this.#b[e],this}#d(t){let r,o=buildComponent(t);return Array.isArray(o)&&(r=document.createDocumentFragment(),o.forEach(e=>{r.appendChild(e)})),{fragment:r,component:o}}setComponent(e,t,r){if(this.getComponent(e)){n({message:"Assignment Error:",error:`The component '${e}' is already assigned`});return}let{fragment:o,component:s}=this.#d(t,r);return this.#a[e]={json:t,element:s,fragment:o,settings:r},this}getComponent(e){return this.#a?.[e]}getComponents(...e){return[...e].map(e=>this.getComponent(e))}componentList(){return Object.entries(this.#a).map(([,e])=>e.fragment??e.element)}removeComponent(e,t){let r=this.getComponent(e)?.element;if(!r){n({message:"Error:",error:`The component '${e}' does not exist`});return}return!Array.isArray(r)&&document.body.contains(r)?r.remove():r.forEach(e=>{document.body.contains(e)&&e.remove()}),t?.deleteComponent&&delete this.#a[e],this}removeComponents(...e){return[...e].forEach(e=>this.removeComponent(e)),this}removeAllComponents(e){return Object.entries(this.#a).forEach(([n])=>this.removeComponent(n,e)),this}changeComponentID(e,t){if(e===t)return;let r=this.getComponent(e),o=this.getComponent(t);if(!r){n({message:"Error:",error:`The component '${e}' does not exist`});return}if(o){n({message:"Assignment error:",error:`The component '${t}' is already assigned`});return}return this.setComponent(t,r.json),delete this.#a[e],this}replaceComponent(e,t,r){let o=this.getComponent(e),{fragment:s,component:i}=this.#d(t,r);if(!o){n({message:"Error:",error:`The component '${e}' does not exist`});return}if(Array.isArray(o.element)){if(!document.body.contains(o.element[0])){n({message:"Error:",error:`The component '${e}' does not exist`});return}o.element.forEach(e=>{e.replaceWith(s??i)})}else{if(!document.body.contains(o.element)){n({message:"Error:",error:`The component '${e}' does not exist`});return}o.element.replaceWith(s??i)}return this.#a[e]={json:t,element:i,fragment:s,settings:r},this}appendComponent(e,t){let r=this.getComponent(t);if(!r){n({message:"Error:",error:`The component '${t}' does not exist`});return}return appendChildren(e,r.fragment??r.element),this}insertComponentBefore(e,t,r){let o=this.getComponent(t);if(!o){n({message:"Error:",error:`The component '${t}' does not exist`});return}return insertChildrenBefore(e,o.fragment??o.element,r),this}get componentCount(){return Object.entries(this.#a).length}get componentIDs(){return Object.entries(this.#a).map(([e])=>e)}set layout(e){this.#c=e}get layout(){return this.#c}}export{buildComponent as jsonElementify,jsonElementAppend,checkExists,setFallback,appendChildren,insertChildrenBefore,className,elementAppended,ComponentManager,checkEvent,render};